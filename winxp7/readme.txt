RemoteCashClient | CashSvr


RemoteCashClient: ActiveX объект, встраивается в любую среду разработки
поддерживающую механизм OLE, выполняет передачу команд на кассовый
сервер для печати чеков используя фискальный регистратор.

Подключение:

CREATEOBJECT("RemoteCashClient.CRemoteCashClient")

Объект лучше инициализировать 1 раз, при запуске основной программы,
Если инициализация/удаление будет производиться при печати каждого чека,
это существенно замедлит вывод документов.

Свойства:
  Добавлены новые свойства.

для работы в режиме передачи всего чека полностью

.AddLine(SenderId, CmdId, Depart, Text, Qty, Price, Tax1, TPayment, Font, matrix, optional excise)
          - добавляет в пакет команду со всеми параметрами

.SendBuff - посылает весь чек на сервер печати

----------------------------------

.TPayment (1..4) - тип оплаты, прописанные в ФЗ-54, 0 или 1 - наличные, 2 - безналичные, 3 - АВАНС, 4 - кредитом
.Tax1 (0..6) - 0 - без НДС, 1 - 18%, 2 - 10%, 3 - 20%, 4 - без ндс, 5 - 10%, 6 - 118, 7 - 5%, 8 - 7%
.WaitNDoc (0,1) - ожидание номера документа после печати чека
.TimeOut (время, с.) - таймаут ожидания любой команды. для ожидания номера документа
                       необходимо значение большее, чем для любой другой команды
.LastNDoc (int) - номер документа возвращенный регистратором
.matrix - строка считанной со сканера марки
.excise - boolean параметр - true для акцизного товара (табак, алкоголь), по умолчанию false
----------------------------------

  .OwnerWnd (HWND, Int, DWord) - Handle окна из которого осуществляется вызов.
                                 Можно указать 0, тогда родительским окном будет 
                                 считаться рабочий стол.

  .SenderId (0..9) - идентификатор клиентской части (в том случае, если на одну кассу 
                     печатаются документы с нескольких станций)

  .InternalMSGs (0,1) - Отключает пользовательские сообщения при установке в 0

  .KeepAlive (0,1) - посылает пустые сообщения (1 раз в 60 сек.) и принимает ответы 
                     для поддержки соединения

  .RemoteIP (string) - IP-адрес компьютера, на котором работает кассовый сервер

  .RemotePort (Int, DWord) - TCP-Порт назначенный на кассовом сервере (по-умолчанию 9514)
  
  .CmdId (0..255) - Идентификатор команды для регистратора.

         0 - Инициирует новый документ в буфере кассового сервера.
             При этом удаляются все предыдущие (незавершенные командой 255)
         1 - Печать строки, установленной свойствами "Text","Font"
         2 - Продажа, используется "Text","Depart","Qty","Price"
         3 - Возврат, используется "Text","Depart","Qty","Price"
         4 - Закрыть чек, используется "Text", выводится перед суммой чека.
                          может быть пустая строка.
         5 - Отрезать чек, обычно используется если в кассовом регистраторе
             не установлена опция автоматической отрезки при завершении чека
             или печатается нефискальный документ, например простой вывод строк 
             на ленту.
         6 - Открыть денежный ящик
         7 - телефон покупателя
         8 - емэйл покупателя
         15 - печать QR-кода (текст для QR-кода передаётся через свойство Text или matrix)
       255 - Завершает сессию документа, инициирует печать. Если KeepAlive = 0,
             разрывает соединение с сервером.
       1021 - установить фамилию кассира, берёт из параметра text

  .Font (0,1) - 0 нормальный шрифт, 1 жирная строка

  .Depart (0..16) - номер отдела

  .Text (string) - текст для печати на ленте ФР

  .Qty (double, currency, float, numeric) - количество для продажи/возврата

  .Price (double, currency, float, numeric) - цена 

  .SendRes (0,1 только чтение) - результат обработки команды

Метод:

  .SendCmd - метод инициирующий отправку команды на сервер.


———————————————————————————————————————————————————————————————————————————————

CashServer.

Настройки в Ini-файле:
[Local]
Port=9514     - TCP-порт

[FRCash]
Type=Shtrih,Mercury,MStar,Felix,S500N(штрих-500)      
              - тип кассовой машины  (пока только 2, второй - бета)
Port=1        - номер последовательного порта
Baud=5        - скорость порта (5=57600, 4=38400, 3=19200 и т.д.) 
Password=0000 - пароль регистратора
AlertSnd=1    - звонок регистратором при подключении к серверу
                клиентской части. (0=не звенеть)
-----------
Кнопки в окне сервера все с хинтами, надеюсь, будет понятно.

Пример простого чека:


//...Инициализация объекта
MyCashObject = CREATEOBJECT('RemoteCashClient.CRemoteCashClient');

// Установка начальных параметров
MyCashObject.OwnerWnd = 0;
MyCashObject.SenderId = 1;
MyCashObject.RemoteIP = '192.168.0.55';
MyCashObject.RemotePort = 9514;
MyCashObject.KeepAlive = 1;


//				начало документа

MyCashObject.CmdId = 0;
MyCashObject.Font = 0;
MyCashObject.SendCmd;

if MyCashObject.SendRes = 0 then
	ShowMessage('Ошибка при отсылке данных на сервер');
	Return 0
End;

//				дополнительный заголовок в документе
MyCashObject.Text = 'Тестирование кассового моста';
MyCashObject.CmdId = 1;					// печать строки
MyCashObject.SendCmd;
MyCashObject.Text = 'Оператор:' + 'Администратор'
MyCashObject.CmdId = 1;					// печать строки
MyCashObject.SendCmd;

//установка имени кассира перед отбитием чека
MyCashObject.Text = 'Имя кассира';
MyCashObject.CmdId = 1021;
MyCashObject.SendCmd;

//				Продажа

MyCashObject.Text = 'тестовый товар';
MyCashObject.Qty = 1;
MyCashObject.Price = 10;
//марка
MyCashObject.Matrix:='010460043993125621JgXJ5.T\u001d8005112000\u001d930001\u001d923zbrLA==\u001d24014276281';
MyCashObject.CmdId = 2;
MyCashObject.SendCmd;
//				Закрыть чек
MyCashObject.Text = 'спасибо за покупку';
MyCashObject.CmdId = 4;
MyCashObject.SendCmd;
//				Открыть ящик
MyCashObject.CmdId = 6;
MyCashObject.SendCmd;
//				Завершить передачу документа
MyCashObject.CmdId = 255;
MyCashObject.SendCmd;
